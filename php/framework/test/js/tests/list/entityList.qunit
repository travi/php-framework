(function () {
    "use strict";

    var $templateLoader = $.Deferred(),
        PAGE_EVENT = 'updates-loaded',
        HIDDEN_CLASS = 'outOfRange';


    $.when(
        travi.loadTemplate('/resources/shared/templates/pagination.tmpl', 'pagination'),

        $.Deferred(function (deferred) {
            $(deferred.resolve);
        })
    ).done(function () {
        $templateLoader.resolve();
    });

    $(document).ready(function () {
        $('#confirmation').dialog('destroy');
        $('#confirmation').remove();
    });

    $.mockjax({
        url: "/admin/updates/45",
        contentType: 'text/json',
        responseText: {test: "test"}
    });

    module("POST handling for 'Remove' action", {
        setup: function () {
                $('body').append('<div id="scratch">');
                $('#entity-list').tmpl().appendTo('#scratch');
                travi.framework.entityList.init();
            },
        teardown: function () {
                $('#scratch').remove();
                $('#confirmation').dialog('destroy').remove();
            }
    });

    test("Form conversion to link", function () {
        //Setup
        $('form').unbind('submit').submit(function () {
            $('#scratch').append('<div id="submitVerify">form submitted</div>');
            return false;
        });

        expect(4);
        //Exercise

        $('a.item-action').click();
        //Verify
        strictEqual($('form').length, 1, 'form exists');
        ok($('form').is(':not(:visible)'), "form no longer visible");
        ok($("li.remove-item a.item-action").is(':visible'), "link visible");
        strictEqual($('#submitVerify').length, 1, "click submits form");
    });


    test("Ajax submission", function () {
        expect(2);
        $('#scratch').bind('entityRemoved', function () {
            strictEqual($('.entityList>li').length, 0, 'Entity removed from list');
            start();
        });
        $('a.item-action').click();
        strictEqual($('.entityList>li').length, 1, 'Correct starting number of entities in list');

        //Exercise
        stop();
        $('.ui-dialog-buttonpane button').eq(0).click();
    });
    module("Remove Confirmation", {
        setup: function () {
                $('body').append('<div id="scratch">');
                $('#entity-list').tmpl().appendTo('#scratch');
                travi.framework.entityList.init();
            },
        teardown: function () {
                $('#scratch').remove();
                $('#confirmation').dialog('destroy').remove();
            }
    });
    test("confirmation dialog", function () {
        //Setup

        expect(5);
        //Verify
        strictEqual($('#confirmation').length, 1, 'confirmation div exists');

        ok($('#confirmation').is(':not(:visible)'), "confirmation not shown");
        //Exercise

        $('form').submit();
        //Verify
        ok($('#confirmation').is(':visible'), "confirmation shown");
        strictEqual($('div.ui-widget-overlay').length, 1, 'is modal');
        strictEqual($('#confirmation').dialog('option', 'modal'), true, 'is modal');
    });

    test("confirmation button text", function () {
        //Setup
        travi.framework.entityList.setButtonText('Remove');
        $('form').submit();

        expect(2);
        //Verify
        strictEqual(travi.framework.entityList.getButtonText(), 'Remove', "Button text reported correctly");
        strictEqual($('#confirmation').dialog('option', 'buttons')[0].text, 'Remove', "Button text displayed correctly");
    });


    test("confirmation message", function () {
        //Setup
        travi.framework.entityList.setConfirmationMessage('Are you sure you wish to REMOVE this announcement?');
        expect(2);

        //Verify
        strictEqual($('#confirmation').text(), 'Are you sure you wish to REMOVE this announcement?',
                "Confirmation message correct");
        strictEqual($('#confirmation').dialog('option', 'title'), 'Are you sure?', "Title text correct");
    });

    $templateLoader.done(function () {

        $.mockjax({
            url: "/admin/updates/?offset=5",
            contentType: 'text/json',
            responseText: {
                test: "test",
                updates: {
                    updateList: {
                        entities: [
                            {}
                        ],
                        offset: 5
                    }
                }
            }
        });
        $.mockjax({
            url: "/admin/updates/?offset=0",
            contentType: 'text/json',
            responseText: {
                test: "test",
                updates: {
                    updateList: {
                        entities: [
                            {}
                        ]
                    }
                }
            }
        });
        module("Paging", {
            setup: function () {
                    $('body').append('<div id="scratch">');
                    $('#entity-list').tmpl().appendTo('#scratch');
                    $('#scratch')
                        .append($.tmpl("pagination", {
                            controller: 'admin/updates',
                            nextOffset: 5,
                            prevOffset: 0
                        }));
                    travi.framework.entityList.init();
                },
            teardown: function () {
                    $('#scratch').remove();
                    $(document).unbind(PAGE_EVENT);
                }
        });
        asyncTest("Request for more updates loads more items into page", function () {
            expect(4);

            $(document).bind(PAGE_EVENT, function () {
                ok(true, "response received from server");
                strictEqual($('ol.entityList > li').length, 2);
                ok(!$('#previousUpdates').parent().hasClass(HIDDEN_CLASS), "'back' link visible");
                ok(!$('.pipeDivider').hasClass(HIDDEN_CLASS), "Divider visible");

                start();
            });
            $('#moreUpdates').click();
        });
        asyncTest("Request for previous updates loads more items into page", function () {
            expect(2);

            $(document).bind(PAGE_EVENT, function () {
                ok(true, "response received from server");
                strictEqual($('ol.entityList > li').length, 2);

                start();
            });
            $('#previousUpdates').click();
        });
        asyncTest("return to first page", function () {
            var $prevUpdates = $('#previousUpdates'),
                $divider = $('.pipeDivider');
            expect(2);
            $prevUpdates.parent().removeClass('outOfRange');
            $divider.removeClass('outOfRange');

            $(document).bind(PAGE_EVENT, function () {
                ok($prevUpdates.parent().hasClass(HIDDEN_CLASS), "'back' link not visible");
                ok($divider.hasClass(HIDDEN_CLASS), "Divider not visible");

                start();
            });

            $prevUpdates.click();
        });
        test("load last page", function () {
            ok(false, 'missing functionality');
        });
    });
}());