<?xml version="1.0" ?>
<project name="framework" default="build">
	<import file="build-shared.xml"/>
	<property file="/home/travi/include/build/build.properties" />
	
	<target name="build" depends="test">
        <antcall target="phpUnit"/>
	</target>
	
	<target name="test" depends="checkstyle">
		<antcall target="php.simpletest.test" />
	</target>
	
	<target name="checkstyle">
		<antcall target="jsLint" />
	</target>

    <target name="phpUnit" description="PHPUnit Test Runner">
        <mkdir dir="${build.logs}"/>
        <exec dir="${framework.php.tests.dir}" executable="phpunit" failonerror="true">
            <arg line=" --log-junit         ${build.logs}/phpunit.xml
                        --coverage-clover   ${build.logs}/clover.xml
                        --coverage-html     ${build.dir}/coverage
                        controller" />
        </exec>
    </target>
	
    <target name="jsLint" description="JSLint">
        <mkdir dir="${build.logs}"/>
        <jslint options="${jslint.goodparts}" haltonfailure="${not.on.teamcity}">
            <predef>${jslint.predef.jquery},${jslint.predef.qunit},travi</predef>            
            <formatter type="plain" />
            <formatter type="xml" destfile="${build.logs}/jslint.xml" />
            <fileset dir="../client/js/" >
                <include name="**/*.js" />
				<include name="**/*.qunit" />
                <exclude name="date/**/*.js" />
                <exclude name="jquery/**/*.js" />
                <exclude name="pngFix/**/*.js" />
                <exclude name="reflection/**/*.js" />
                <exclude name="unit/**/*.js" />
            </fileset>
            <fileset dir="../client/js/" >
            	<!-- My Plug-ins -->
            	<include name="jquery/plugins/formAlign/*.js" />
			</fileset>
            <fileset dir="../php/framework/test/js/tests/">
				<include name="**/*.qunit" />
            </fileset>
        </jslint>
		<xslt in="jslint.xml" out="jslint-junit.xml" style="jslint.xsl" />
    </target>
	
	<target name="php.simpletest.test">
		<exec executable="php" failonerror="false">
			<arg line="/home/travi/include/php/framework/test/framework.runner.php -junit" />
		</exec>		
        <groovy>
            def xml = new XmlSlurper().parse("/home/travi/include/build/simpletest.xml")
            def failures = xml.@failures
            if (failures != 0) properties["simpletest-failure"] = true
        </groovy>
        <fail if='simpletest-failure' message="There were Simpletest failures"/>
	</target>
	
	<target name="minify">		
        <yuicompress warn="false" munge="yes" preserveallsemicolons="true"
            outputfolder="../client/min/css/" >
            <fileset dir="../client/css/" >
                <include name="**/*.css" />
            </fileset>
        </yuicompress>	
        <yuicompress warn="false" munge="yes" preserveallsemicolons="true"
            outputfolder="../client/min/js/" >
            <fileset dir="../client/js/" >
                <include name="**/*.js" />
                <include name="**/*.css" />
            </fileset>
        </yuicompress>
        <copy todir="../client/min/js/jquery/plugins/wymeditor/skins/silver/images">
            <fileset dir="../client/js/jquery/plugins/wymeditor/skins/silver/images"/>
        </copy>
	</target>

    <target name="clean">
        <delete dir="${build.logs}"/>
        <delete dir="${build.dir}/coverage"/>
    </target>
</project>
